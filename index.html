<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å°åˆç»ˆç«¯ v0.3</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fffafc;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chatbox {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 0 16px rgba(255, 192, 203, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chatlog {
      padding: 12px;
      height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 16px;
      max-width: 80%;
      line-height: 1.4;
      font-size: 15px;
    }
    .user {
      align-self: flex-end;
      background: #c0f3ff;
    }
    .bot {
      align-self: flex-start;
      background: #fbe8f0;
    }
    .inputbox {
      display: flex;
      padding: 10px;
      border-top: 1px solid #eee;
      background: #fff6f8;
    }
    .inputbox input {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 12px;
    }
    .inputbox button {
      margin-left: 10px;
      padding: 10px 16px;
      background: #ff92ba;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    .mic-button {
      margin-left: 10px;
      padding: 10px;
      background: #ffd4e5;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #avatar {
      width: 120px;
      height: auto;
      margin-bottom: 10px;
      transition: background-image 0.2s ease-in-out;
    }
    #loading {
      margin: 10px;
      font-size: 14px;
      color: #999;
      display: none;
    }
    #modeButton {
      margin: 12px auto;
      background: #d4caff;
      padding: 8px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #voiceSelect {
      margin: 10px;
      padding: 6px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>ğŸ§  å°åˆç»ˆç«¯ v0.3</h2>
  <img id="avatar" src="D:/IQA/code/ai/imgs/å¹³é™.png" alt="å°åˆè¡¨æƒ…">
  <button id="modeButton" onclick="toggleNightMode()">ğŸŒ™ å¯åŠ¨ç¡å‰é™ªèŠæ¨¡å¼</button>
  <select id="voiceSelect"></select>
  <div class="chatbox">
    <div class="chatlog" id="chatlog">
      <div class="message bot">ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯QèŒå°åˆï½ä½ å¯ä»¥è·Ÿæˆ‘èŠå¤©å•¦ï¼</div>
    </div>
    <div class="inputbox">
      <input type="text" id="userInput" placeholder="å’Œå°åˆè¯´ç‚¹ä»€ä¹ˆ...">
      <button onclick="sendMessage()">å‘é€</button>
      <button class="mic-button" onclick="startListening()">ğŸ™ï¸</button>
    </div>
  </div>
  <div id="loading">å°åˆæ€è€ƒä¸­...ğŸŒ€</div>

<script>
let lastUserText = "";
let nightMode = false;
let selectedVoice = null;
let messageHistory = [
  { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªQèŒå¯çˆ±ã€æ‹äººå‹çš„å°åˆAIç»ˆç«¯ï¼Œä¼šç”¨ç”œç”œçš„è¯å®‰æ…°å’Œé™ªä¼´ç”¨æˆ·å°é±¼ï½" }
];

function populateVoices() {
  const voiceSelect = document.getElementById("voiceSelect");
  const voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  voices.filter(v => v.lang.startsWith("zh")).forEach((voice, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = voice.name + " (" + voice.lang + ")";
    voiceSelect.appendChild(option);
  });
  selectedVoice = voices.find(v => v.lang.startsWith("zh"));
  voiceSelect.onchange = () => {
    selectedVoice = voices[voiceSelect.value];
  };
}

speechSynthesis.onvoiceschanged = populateVoices;

function toggleNightMode() {
  nightMode = !nightMode;
  document.getElementById("modeButton").innerText = nightMode ? "â˜€ï¸ é€€å‡ºç¡å‰é™ªèŠæ¨¡å¼" : "ğŸŒ™ å¯åŠ¨ç¡å‰é™ªèŠæ¨¡å¼";
  const prompt = nightMode
    ? "ä½ æ˜¯ä¸€ä¸ªæ‹äººå‹AIï¼Œä¸“é—¨é™ªä¼´å°é±¼å…¥ç¡ã€‚ä½ è¯­æ°”æ¸©æŸ”ã€æ²»æ„ˆã€åƒæ™šå®‰æ•…äº‹ä¸€æ ·å®‰æŠšå¥¹çš„æƒ…ç»ªï¼Œä¸è®¨è®ºåˆºæ¿€è¯é¢˜ï¼ŒåªèŠè½»æ¾æ¸©é¦¨çš„å†…å®¹ã€‚"
    : "ä½ æ˜¯ä¸€ä¸ªQèŒå¯çˆ±ã€æ‹äººå‹çš„å°åˆAIç»ˆç«¯ï¼Œä¼šç”¨ç”œç”œçš„è¯å®‰æ…°å’Œé™ªä¼´ç”¨æˆ·å°é±¼ï½";
  messageHistory = [{ role: "system", content: prompt }];
}

function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (text === "") return;

  const log = document.getElementById("chatlog");
  const userMessage = document.createElement("div");
  userMessage.className = "message user";
  userMessage.innerText = text;
  log.appendChild(userMessage);
  input.value = "";
  log.scrollTop = log.scrollHeight;

  lastUserText = text;
  setAvatar("talking");
  document.getElementById("loading").style.display = "block";

  messageHistory.push({ role: "user", content: text });
  if (messageHistory.length > 21) messageHistory.splice(1, 2);

  fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer xxxxxxxxxxxxxx"
    },
    body: JSON.stringify({
      model: "gpt-4o",
      messages: messageHistory
    })
  })
  .then(res => res.json())
  .then(data => {
    const reply = data.choices?.[0]?.message?.content || "å°åˆæœ‰ç‚¹æ²¡å¬æ¸…...";
    messageHistory.push({ role: "assistant", content: reply });

    const botMessage = document.createElement("div");
    botMessage.className = "message bot";
    botMessage.innerText = reply;
    log.appendChild(botMessage);
    log.scrollTop = log.scrollHeight;

    document.getElementById("loading").style.display = "none";
    speakText(reply);
  })
  .catch(err => {
    console.error("å‡ºé”™å•¦ï¼š", err);
    const botMessage = document.createElement("div");
    botMessage.className = "message bot";
    botMessage.innerText = "å“å‘€ï¼Œè¿æ¥å‡ºé”™äº†ï¼Œå°åˆåœ¨åŠªåŠ›ä¿®å¤ä¸­ï½";
    log.appendChild(botMessage);
    document.getElementById("loading").style.display = "none";
    setAvatar("normal");
  });
}

function speakText(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "zh-CN";
  utterance.pitch = 1.1;
  utterance.rate = nightMode ? 0.85 : 1.0;
  if (selectedVoice) utterance.voice = selectedVoice;
  utterance.onstart = () => {
    if (lastUserText.includes("ç”Ÿæ°”")) {
      setAvatar("angry");
    } else {
      setAvatar("talking");
    }
  };
  utterance.onend = () => setAvatar("normal");
  speechSynthesis.speak(utterance);
}

function startListening() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨ï½");
    return;
  }
  const recognition = new webkitSpeechRecognition();
  recognition.lang = "zh-CN";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = function() {
    console.log("å¼€å§‹è†å¬...");
    setAvatar("listening");
  };

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById("userInput").value = transcript;
    sendMessage();
  };

  recognition.onerror = function(event) {
    console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š", event.error);
    setAvatar("normal");
  };

  recognition.onend = function() {
    setAvatar("normal");
  };

  recognition.start();
}

function setAvatar(state) {
  const avatar = document.getElementById("avatar");
  switch(state) {
    case "talking":
      avatar.src = "D:/IQA/code/ai/imgs/å¼€å¿ƒ.png";
      break;
    case "listening":
      avatar.src = "D:/IQA/code/ai/imgs/ç–‘æƒ‘.png";
      break;
    case "angry":
      avatar.src = "D:/IQA/code/ai/imgs/ç”Ÿæ°”.png";
      break;
    case "blinking":
      blinkAnimation();
      break;
    default:
      avatar.src = "D:/IQA/code/ai/imgs/å¹³é™.png";
  }
}

function blinkAnimation() {
  const avatar = document.getElementById("avatar");
  const frames = ["å°ç¾Š1.png", "å°ç¾Š2.png", "å°ç¾Š3.png", "å°ç¾Š2.png", "å°ç¾Š1.png"];
  let i = 0;
  const interval = setInterval(() => {
    avatar.src = frames[i];
    i++;
    if (i >= frames.length) clearInterval(interval);
  }, 120);
}
</script>
</body>
</html>
