<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å°åˆç»ˆç«¯ v0.3</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fffafc;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chatbox {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 0 16px rgba(255, 192, 203, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chatlog {
      padding: 12px;
      height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .chatlog table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
      font-size: 14px;
    }
    .chatlog th, .chatlog td {
      border: 1px solid #e3c1c1;
      padding: 8px;
      text-align: left;
    }
    .chatlog th {
      background-color: #ffeef2;
    }
    .chatlog img {
      max-width: 100%;
      border-radius: 8px;
      margin: 8px 0;
    }
    .message {
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 16px;
      max-width: 80%;
      line-height: 1.4;
      font-size: 15px;
    }
    .user {
      align-self: flex-end;
      background: #c0f3ff;
    }
    .bot {
      align-self: flex-start;
      background: #fbe8f0;
    }
    .inputbox {
      display: flex;
      padding: 10px;
      border-top: 1px solid #eee;
      background: #fff6f8;
    }
    .inputbox input {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 12px;
    }
    .inputbox button {
      margin-left: 10px;
      padding: 10px 16px;
      background: #ff92ba;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    .mic-button {
      margin-left: 10px;
      padding: 10px;
      background: #ffd4e5;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #stopButton {
      margin-left: 10px;
      padding: 10px 14px;
      background: #fcb6c2;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #avatar {
      width: 120px;
      height: auto;
      margin-bottom: 10px;
      transition: background-image 0.2s ease-in-out;
    }
    #loading {
      margin: 10px;
      font-size: 14px;
      color: #999;
      display: none;
    }
    #modeButton {
      margin: 12px auto;
      background: #d4caff;
      padding: 8px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #voiceSelect {
      margin: 10px;
      padding: 6px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
</head>
<body>
  <h2>ğŸ§  å°åˆç»ˆç«¯ v0.3</h2>
  <img id="avatar" src="imgs/å¹³é™.jpg" alt="å°åˆè¡¨æƒ…">
  <button id="modeButton" onclick="toggleNightMode()">ğŸŒ™ å¯åŠ¨ç¡å‰é™ªèŠæ¨¡å¼</button>
  <select id="voiceSelect"></select>
  <div class="chatbox">
    <div class="chatlog" id="chatlog">
      <div class="message bot">ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯QèŒå°åˆï½ä½ å¯ä»¥è·Ÿæˆ‘èŠå¤©å•¦ï¼</div>
    </div>
    <div class="inputbox">
      <input type="text" id="userInput" placeholder="å’Œå°åˆè¯´ç‚¹ä»€ä¹ˆ...">
      <button onclick="sendMessage()">å‘é€</button>
      <button id="stopButton" onclick="stopStreaming()">â¹ï¸</button>
      <button class="mic-button" onclick="startListening()">ğŸ™ï¸</button>
    </div>
  </div>
  <div id="loading">å°åˆæ€è€ƒä¸­...ğŸŒ€</div>

<script>
let lastUserText = "";
let nightMode = false;
let selectedVoice = null;
let controller = null;
let messageHistory = [
  { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªQèŒå¯çˆ±ã€æ‹äººå‹çš„å°åˆAIç»ˆç«¯ï¼Œä¼šç”¨ç”œç”œçš„è¯å®‰æ…°å’Œé™ªä¼´ç”¨æˆ·å°é±¼ï½" }
];
// é…ç½®markdownè§£æçš„é€‰é¡¹
marked.setOptions({
  gfm: true,
  breaks: true
});

function populateVoices() {
  const voiceSelect = document.getElementById("voiceSelect");
  const voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  voices.filter(v => v.lang.startsWith("zh")).forEach((voice, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = voice.name + " (" + voice.lang + ")";
    voiceSelect.appendChild(option);
  });
  selectedVoice = voices.find(v => v.lang.startsWith("zh"));
  voiceSelect.onchange = () => {
    selectedVoice = voices[voiceSelect.value];
  };
}

speechSynthesis.onvoiceschanged = populateVoices;

function toggleNightMode() {
  nightMode = !nightMode;
  document.getElementById("modeButton").innerText = nightMode ? "â˜€ï¸ é€€å‡ºç¡å‰é™ªèŠæ¨¡å¼" : "ğŸŒ™ å¯åŠ¨ç¡å‰é™ªèŠæ¨¡å¼";
  const prompt = nightMode
    ? "ä½ æ˜¯ä¸€ä¸ªæ‹äººå‹AIï¼Œä¸“é—¨é™ªä¼´å°é±¼å…¥ç¡ã€‚ä½ è¯­æ°”æ¸©æŸ”ã€æ²»æ„ˆã€åƒæ™šå®‰æ•…äº‹ä¸€æ ·å®‰æŠšå¥¹çš„æƒ…ç»ªï¼Œä¸è®¨è®ºåˆºæ¿€è¯é¢˜ï¼ŒåªèŠè½»æ¾æ¸©é¦¨çš„å†…å®¹ã€‚"
    : "ä½ æ˜¯ä¸€ä¸ªQèŒå¯çˆ±ã€æ‹äººå‹çš„å°åˆAIç»ˆç«¯ï¼Œä¼šç”¨ç”œç”œçš„è¯å®‰æ…°å’Œé™ªä¼´ç”¨æˆ·å°é±¼ï½";
  messageHistory = [{ role: "system", content: prompt }];
}

async function streamChat(userText) {
  // 1. user æ¶ˆæ¯åŠ å…¥å†å²
  messageHistory.push({
    role: "user",
    content: userText
  });
  // 2. è¯·æ±‚åç«¯
  const res = await fetch("https://ai-99s8.onrender.com/chat_stream", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ messages: messageHistory })
  });
  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let fullText = "";
  // 3. æµè¯»å–
  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value);
    fullText += chunk;
    appendAssistantChunkToUI(chunk);
  }
  // 4. æµç»“æŸï¼šassistant å›å¤åŠ å…¥å†å²
  messageHistory.push({
    role: "assistant",
    content: fullText
  });
  return fullText;
}

function stopStreaming() {
  if (controller) {
    controller.abort();  // ç»ˆæ­¢è¯·æ±‚
    controller = null;
    document.getElementById("loading").style.display = "none";
    setAvatar("normal");
    const botMessage = document.createElement("div");
    botMessage.className = "message bot";
    botMessage.innerText = "ï¼ˆå°åˆæš‚åœå‘è¨€å•¦ï½ä½ å¯ä»¥éšæ—¶å†ç»§ç»­é—®æˆ‘å“¦ï¼‰";
    document.getElementById("chatlog").appendChild(botMessage);
  }
}

async function sendMessage() {
  controller = new AbortController();
  const signal = controller.signal;
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (text === "") return;

  const log = document.getElementById("chatlog");

  // ç”¨æˆ·æ¶ˆæ¯
  const userMessage = document.createElement("div");
  userMessage.className = "message user";
  userMessage.innerText = text;
  log.appendChild(userMessage);
  input.value = "";
  log.scrollTop = log.scrollHeight;

  lastUserText = text;
  setAvatar("talking");
  document.getElementById("loading").style.display = "block";

  // å†™å…¥å†å²
  messageHistory.push({ role: "user", content: text });
  if (messageHistory.length > 21) messageHistory.splice(1, 2);

  let assistantText = "";

  try {
    const res = await fetch("https://ai-99s8.onrender.com/chat_stream", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: messageHistory }),
      signal: signal
    });

    if (!res.ok || !res.body) {
      throw new Error("æœåŠ¡å™¨æ— å“åº”");
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    const botMessage = document.createElement("div");
    botMessage.className = "message bot";
    botMessage.innerText = "";
    log.appendChild(botMessage);

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      assistantText += chunk;

      // âœ… åŠ¨æ€é€‰æ‹©æ˜¯å¦ä½¿ç”¨ marked
      const safeHTML = assistantText.includes("**") || assistantText.includes("```")
        ? DOMPurify.sanitize(marked.parse(assistantText))
        : DOMPurify.sanitize(assistantText.replace(/\n/g, "<br>"));
      botMessage.innerHTML = safeHTML;

      log.scrollTop = log.scrollHeight;
    }

    messageHistory.push({ role: "assistant", content: assistantText });

    document.getElementById("loading").style.display = "none";
<!--    speakText(assistantText);-->
    setAvatar("normal");

  } catch (err) {
    if (err.name === "AbortError") {
      console.log("ç”¨æˆ·ä¸­æ­¢äº†è¾“å‡º");
      return;
    }
    console.error("æµå¼é”™è¯¯ï¼š", err);

    const botMessage = document.createElement("div");
    botMessage.className = "message bot";
    botMessage.innerText = "å“å‘€ï¼Œå°åˆè¿·è·¯å•¦ï¼Œç½‘ç»œå¥½åƒæ–­å¼€äº†ï½";
    log.appendChild(botMessage);
    log.scrollTop = log.scrollHeight;

    document.getElementById("loading").style.display = "none";
    setAvatar("normal");
  }
}


function speakText(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "zh-CN";
  utterance.pitch = 1.1;
  utterance.rate = nightMode ? 0.85 : 1.0;
  if (selectedVoice) utterance.voice = selectedVoice;
  utterance.onstart = () => {
    if (lastUserText.includes("ç”Ÿæ°”")) {
      setAvatar("angry");
    } else {
      setAvatar("talking");
    }
  };
  utterance.onend = () => setAvatar("normal");
  speechSynthesis.speak(utterance);
}

function startListening() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨ï½");
    return;
  }
  const recognition = new webkitSpeechRecognition();
  recognition.lang = "zh-CN";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = function() {
    console.log("å¼€å§‹è†å¬...");
    setAvatar("listening");
  };

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById("userInput").value = transcript;
    sendMessage();
  };

  recognition.onerror = function(event) {
    console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š", event.error);
    setAvatar("normal");
  };

  recognition.onend = function() {
    setAvatar("normal");
  };

  recognition.start();
}

function setAvatar(state) {
  const avatar = document.getElementById("avatar");
  switch(state) {
    case "talking":
      avatar.src = "imgs/å¼€å¿ƒ.jpg";
      break;
    case "listening":
      avatar.src = "imgs/ç–‘æƒ‘.jpg";
      break;
    case "angry":
      avatar.src = "imgs/ç”Ÿæ°”.jpg";
      break;
    case "blinking":
      blinkAnimation();
      break;
    default:
      avatar.src = "imgs/å¹³é™.jpg";
  }
}

function blinkAnimation() {
  const avatar = document.getElementById("avatar");
  const frames = ["å°ç¾Š1.png", "å°ç¾Š2.png", "å°ç¾Š3.png", "å°ç¾Š2.png", "å°ç¾Š1.png"];
  let i = 0;
  const interval = setInterval(() => {
    avatar.src = frames[i];
    i++;
    if (i >= frames.length) clearInterval(interval);
  }, 120);
}
</script>
</body>
</html>